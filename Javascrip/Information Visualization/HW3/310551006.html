<!DOCTYPE html>
<meta charset="utf-8" />

<!-- http://ed2a88d7628c1d91.vis.lab.djosix.com:2020 -->

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Load plotly.js into the DOM -->
<script src='https://cdn.plot.ly/plotly-2.16.1.min.js'></script>
<body>
	<!-- Create a div where the graph will take place -->
	<label>Popularity Thresh<input id="popularity_input" type="text" value="80" onchange="mainPlot()"></input></label>
	<div id="barChart"></div>
	<div id='ScatterPlot'></div>
	<div id="pieChart1"></div>
	<div id="pieChart2"></div>
	<div id="pieChart3"></div>
	<div id="splom"></div>
	<div id="histogram1"></div>
	<div id="histogram2"></div>
	<div id="histogram3"></div>
	<div id="histogram4"></div>
	<div id="stackBar1"></div>
</body>


<!-- plotly scatter  -->
<script>
	function scatter(x, y, xLabel, yLabel){
		
		// console.log(x);
		var scatter = {
			x: x,
			y: y,
			mode: 'markers',
			type: 'scatter'
			}

		var layout = {
			xaxis: {
				title: {
				text: xLabel,
				font: {
					family: 'Courier New, monospace',
					size: 18,
					color: '#7f7f7f'
				}
				},
			},
			yaxis: {
				title: {
				text: yLabel,
				font: {
					family: 'Courier New, monospace',
					size: 18,
					color: '#7f7f7f'
				}
				}
			}
		}

		Plotly.newPlot('ScatterPlot', [scatter], layout);

	}

	function pieChart(x, y, div, title){
		var data = {};
		for(var i = 0; i < x.length; i++){
			if(y[i] in data){
				data[y[i]] += 1;
			}
			else{
				data[y[i]] = 1;
			}
		}
		
		var data = [{
			values: Object.values(data),
			labels: Object.keys(data),
			type: 'pie'
		}];

		var layout = {
		height: 800,
		width: 800,
		title: title
		};

		Plotly.newPlot(div, data, layout);
	}
</script>

<!-- scatter matrix -->
<script>
	function splom(rows){

		function unpack(rows, key) {
			return rows.map(function(row) { return row[key]; });
		}

		text = unpack(rows, 'popularity')
		// for (i=0; i < unpack(rows, 'popularity').length; i++) {
			
		// 	text.push(unpack(rows, 'popularity')[i]);
			
		// }

		var pl_colorscale=[
		[0.8, '#119dff'],
		[0.9, '#119dff'],
		[0.9, '#99FF33'],
		[1, '#99FF33']
		]

		var axis = () => ({
		showline:false,
		zeroline:false,
		gridcolor:'#ffff',
		ticklen:2,
		tickfont:{size:10},
		titlefont:{size:12}
		})

		var data = [{
		type: 'splom',
		dimensions: [
			{label:'popularity', values:unpack(rows, 'popularity')},
			{label:'duration_ms', values:unpack(rows, 'duration_ms')},
			{label:'danceability', values:unpack(rows, 'danceability')},
			{label:'energy', values:unpack(rows, 'energy')},
			{label:'loudness', values:unpack(rows, 'loudness')},
			{label:'mode', values:unpack(rows, 'mode')},
			{label:'speechiness', values:unpack(rows, 'speechiness')},
			{label:'acousticness', values:unpack(rows, 'acousticness')},
			{label:'instrumentalness', values:unpack(rows, 'instrumentalness')},
			{label:'liveness', values:unpack(rows, 'liveness')},
			{label:'valence', values:unpack(rows, 'valence')},
			{label:'tempo', values:unpack(rows, 'tempo')},
			{label:'time_signature', values:unpack(rows, 'time_signature')},
		],
		text:text,
		marker: {
			color: unpack(rows, 'popularity'),
			colorscale:pl_colorscale,
			size: 5,
			line: {
			color: 'white',
			width: 0.5
			}
		}
		}]

		var layout = {
		// title:"Scatterplot Matrix (SPLOM) for Diabetes Dataset<br>Data source: <a href='https://www.kaggle.com/uciml/pima-indians-diabetes-database/data'>[1]</a>",
		height: 1400,
		width: 1920,
		autosize: false,
		hovermode:'closest',
		dragmode:'select',
		plot_bgcolor:'rgba(240,240,240, 0.95)',
		xaxis:axis(),
		yaxis:axis(),
		xaxis2:axis(),
		xaxis3:axis(),
		xaxis4:axis(),
		xaxis5:axis(),
		xaxis6:axis(),
		xaxis7:axis(),
		xaxis8:axis(),
		xaxis9:axis(),
		xaxis10:axis(),
		xaxis11:axis(),
		xaxis12:axis(),
		xaxis13:axis(),
		yaxis2:axis(),
		yaxis3:axis(),
		yaxis4:axis(),
		yaxis5:axis(),
		yaxis6:axis(),
		yaxis7:axis(),
		yaxis8:axis(),
		yaxis9:axis(),
		yaxis10:axis(),
		yaxis11:axis(),
		yaxis12:axis(),
		yaxis13:axis(),
		}

		Plotly.react('splom', data, layout);

	}

</script>


<!-- histogram -->
<script>
	function histogram(x, div, title){
		
		var trace = {
			x: x,
			type: 'histogram',
		};
		var data = [trace];

		var layout={
			title:title,
		}
		Plotly.newPlot(div, data, layout);
	}
</script>

<!-- stack bar -->
<script>
	function stackBar(x, y, div){
		var sampleSpacing = 5
		var popularityThresh = Math.floor(document.getElementById("popularity_input").value)
		var chartData = []
		var sampleDataList = []
		
		for(var j = popularityThresh;j < 100;j += sampleSpacing){
			var sampleData = {};
			for(var i = 0; i < x.length; i++){
				if(x[i] in sampleData){
					if(y[i] >= j)
						sampleData[x[i]] += 1;
				}
				else
					sampleData[x[i]] = 1;
				
			}
			sampleDataList.push(sampleData)
		}

		y = d3.range(popularityThresh, 100, sampleSpacing)

		var keys = Object.keys(sampleDataList[0])
		for (var i = 0; i < keys.length; i++) {
			var x = []
			for(var j = 0; j < sampleDataList.length; j++){//make x
				if(keys[i] in sampleDataList[j]){
					x.push(sampleDataList[j][keys[i]])
				}
				else
					x.push(0)
			}


			chartData.push(
				{
				y:y,
				x:x,
				orientation: 'h',
				name: keys[i],
				type: 'bar'
				}
			)
		}

		var layout = {barmode: 'stack'};

		Plotly.newPlot(div, chartData, layout);

	}

</script>


<script>
	function mainPlot(){
		d3.csv("http://vis.lab.djosix.com:2020/data/spotify_tracks.csv").then((data)=>{
		var popularityThresh = Math.floor(document.getElementById("popularity_input").value)
		//We only care popularity >= 80
		data = data.filter( d => {
			if(d['popularity'] >= popularityThresh)
				return d;
		});

		x = d3.map(data, d => d.duration_ms);
		y = d3.map(data, d => d.popularity);
		x = x.map(i => Math.floor( i / 1000));
		scatter(x, y, 'Duration(s)', 'Popularity');

		x = d3.map(data, d => d.popularity);
		y = d3.map(data, d => d.track_genre);
		pieChart(x, y, "pieChart1", "Track genre, Popularity>=" + popularityThresh);

		x = d3.map(data, d => d.popularity);
		y = d3.map(data, d => d.mode);
		pieChart(x, y, "pieChart3", "Mode, Popularity>=" + popularityThresh);

		x = d3.map(data, d => d.popularity);
		y = d3.map(data, d => d.explicit);
		pieChart(x, y, "pieChart2", "Explicit, Popularity>=" + popularityThresh);

		splom(data);

		// x = d3.map(data, d => d.popularity);

		// histogram(x, "histogram1", "Popularity Histogram");

		x = d3.map(data, d => d.time_signature);
		histogram(x, "histogram2", "Time Signature Histogram");

		x = d3.map(data, d => d.mode);
		histogram(x, "histogram3", "Mode Histogram");

		artists = d3.map(data, d => d.artists);
		x = [];
		for (let i = 0; i < artists.length; i++) {//split artists
			var tmp = artists[i].split(";")
			if(tmp.constructor === Array){
				for (let j = 0; j < tmp.length; j++) {
					x.push(tmp[j])
				}
			}
			else
				x.push(tmp)
			
		}
		histogram(x, "histogram4", "Artists Histogram");

		x = d3.map(data, d => d.track_genre)
		y = d3.map(data, d => d.popularity)
		stackBar(x, y, "stackBar1")

	});
	}
	
	mainPlot();

</script>
